{% extends "base.html" %}
{% load static %}

{% block content %}

    <script src="{% static 'vendor/fullcalendar-6.1.10/dist/index.global.min.js' %}"></script>
    <script>
        var styleSheet = document.getElementById("draculaStylesheet");
        styleSheet.disabled = true;
        //styleSheet.parentNode.removeChild(styleSheet);
        document.addEventListener("DOMContentLoaded", function() {
            var calendarEl = document.getElementById("calendar");
            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: "fr",
                initialView: "timeGridWeek",
                firstDay: 1,
                titleFormat: { year: "numeric", month: "long", day: "numeric" },
                buttonText: {
                    today:    "Aujourd'hui",
                    month:    "Mois",
                    week:     "Semaine",
                    day:      "Jour",
                    list:     "Liste"
                },
                allDaySlot: false,
                dayHeaderFormat: { weekday: "long" },
                headerToolbar: {
                    left: '',
                    center: '',
                    right: "prev,next"
                },
                selectable: true,
                height: "auto",
                eventBackgroundColor: "#44475A",
                eventBorderColor: "#BD93F9",
                eventTextColor: "#F8F8F2",
                eventClick: function(info) {
                    if (info.event.extendedProps.nbPlacesRestantes <= 0) {
                        return;
                    }
                    document.getElementById("eventDetails").innerText = 
                        info.event.title + ", " +
                        info.event.extendedProps.jourSeance + ", " +
                        info.event.start.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" }) + ", " +
                        "Durée: " + minutesToTimeString(calculateDurationInMinutes(info.event.start.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" }), info.event.extendedProps.dureeSeance)) + ", " +
                        "Places: " + info.event.extendedProps.nbPlaces + ", " +
                        "Restantes: " + info.event.extendedProps.nbPlacesRestantes;
                    if (selectedEventId) {
                        var oldEvent = calendar.getEventById(selectedEventId);
                        if (oldEvent) {
                            oldEvent.setProp('backgroundColor', '#44475A');
                            oldEvent.setProp('textColor', '#F8F8F2');
                        }
                    }
                    info.event.setProp('backgroundColor', '#50FA7B');
                    info.event.setProp('textColor', '#282A36');
                    selectedEventId = info.event.id;
                    document.getElementById("selectedEventId").value = selectedEventId;
                    document.getElementById("eventForm").style.display = "";
                },
                eventMouseEnter: function(info) {
                    if (info.event.extendedProps.nbPlacesRestantes > 0) {
                        info.el.style.cursor = "pointer";
                    } else {
                        return;
                    }
                    var tooltip = document.createElement("div");
                    tooltip.style.position = "absolute";
                    tooltip.style.top = info.jsEvent.pageY + "px";
                    tooltip.style.left = info.jsEvent.pageX + "px";
                    tooltip.style.backgroundColor = "#282A36";
                    tooltip.style.color = "#F8F8F2";
                    tooltip.style.padding = "5px";
                    tooltip.style.borderRadius = "5px";
                    tooltip.style.zIndex = "1000";
                    tooltip.innerText = 
                        info.event.title + ", " +
                        info.event.extendedProps.jourSeance + ", " +
                        info.event.start.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" }) + ", " +
                        "Durée: " + minutesToTimeString(calculateDurationInMinutes(info.event.start.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" }), info.event.extendedProps.dureeSeance)) + ", " +
                        "Places: " + info.event.extendedProps.nbPlaces + ", " +
                        "Restantes: " + info.event.extendedProps.nbPlacesRestantes;
                    document.body.appendChild(tooltip);
                    info.el.addEventListener("mouseleave", function() {
                        try {
                            if (tooltip && tooltip.parentNode) {
                                tooltip.parentNode.removeChild(tooltip);
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    });
                },
            });

            const dayNameToIndex = {
                "Dimanche": 0,
                "Lundi": 1,
                "Mardi": 2,
                "Mercredi": 3,
                "Jeudi": 4,
                "Vendredi": 5,
                "Samedi": 6
            };
            const currentDate = new Date();
            const currentDayIndex = currentDate.getDay();
			console.log("currentDayIndex: " + currentDayIndex);
            var events = [];

            {% for instance in data %}
				var desiredDay = '{{ instance.jour }}';
				var desiredDayIndex = dayNameToIndex[desiredDay];
				var daysDifference = desiredDayIndex - currentDayIndex;
				var originalDaysDifference = Math.abs(daysDifference);
				var desiredDate = new Date(currentDate);

				console.log("desiredDay: " + desiredDay);
				console.log("desiredDayIndex: " + desiredDayIndex);
				console.log("daysDifference: " + daysDifference);
				console.log("originalDaysDifference: " + originalDaysDifference);
				
				if (desiredDayIndex == currentDayIndex) {
					// do nothing
					console.log("do nothing");
				} else if (currentDayIndex == 0) {
					daysDifference -= 7;
					console.log("currentDayIndex == 0");
				} else if (originalDaysDifference == 6) {
					daysDifference += 7;
					console.log("originalDaysDifference == 6");
				} else if (desiredDayIndex == 0 && daysDifference < 0) {
					daysDifference += 7;
					console.log("desiredDayIndex == 0 && daysDifference < 0");
				}
				
				desiredDate.setDate(currentDate.getDate() + daysDifference);
				console.log("desiredDate: " + desiredDate);
				var formattedDate = desiredDate.toISOString().slice(0, 10);

				var event = {
					id: "{{ instance.idSeance }}",
					title: "{{ instance.typeSeance }}{% if instance.niveau != '' %} - {{ instance.niveau }}{% endif %}",
					start: "{{ instance.heureSeance|safe }}",
					end: "{{ instance.dureeSeance|safe }}",
					allDay: false,
					extendedProps: {
						nbPlaces: "{{ instance.nbPlaces }}",
						nbPlacesRestantes: "{{ instance.nbPlacesRestantes }}",
						professeur: "{{ instance.professeur }}",
						dureeSeance: "{{ instance.dureeSeance }}",
                        jourSeance: "{{ instance.jour }}",
					},
                    backgroundColor: "{% if instance.nbPlacesRestantes > 0 %}#44475A{% else %}#FF5555{% endif %}",
                    textColor: "{% if instance.nbPlacesRestantes > 0 %}#F8F8F2{% else %}#282A36{% endif %}"
				};
				event.start = formattedDate + 'T' + event.start;
				event.end = formattedDate + 'T' + event.end;
	
				events.push(event);
            {% endfor %}

            calendar.addEventSource(events);
            calendar.render();
        });
    </script>

    <h1>Choisissez votre créneau</h1>
    <div id="eventDetails"></div>
    <form id="eventForm" style="display: none;" action="votre_url_suivante" method="post">
        <input type="hidden" id="selectedEventId" name="selectedEventId" value="0">
        {% csrf_token %}
        <button type="submit">Suivant</button>
    </form>
    <div id="calendar"></div>

{% endblock %}
